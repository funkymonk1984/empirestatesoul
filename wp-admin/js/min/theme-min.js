window.wp=window.wp||{},function($){var e,t;e=wp.themes=wp.themes||{},e.data=_wpThemeSettings,t=e.data.l10n,e.isInstall=!!e.data.settings.isInstall,_.extend(e,{model:{},view:{},routes:{},router:{},template:wp.template}),e.Model=Backbone.Model.extend({initialize:function(){var t;-1!==_.indexOf(e.data.installedThemes,this.get("slug"))&&this.set({installed:!0}),this.set({id:this.get("slug")||this.get("id")}),this.has("sections")&&(t=this.get("sections").description,this.set({description:t}))}}),e.view.Appearance=wp.Backbone.View.extend({el:"#wpbody-content .wrap .theme-browser",window:$(window),page:0,initialize:function(t){_.bindAll(this,"scroller"),this.SearchView=t.SearchView?t.SearchView:e.view.Search,this.window.bind("scroll",_.throttle(this.scroller,300))},render:function(){this.view=new e.view.Themes({collection:this.collection,parent:this}),this.search(),this.view.render(),this.$el.empty().append(this.view.el).addClass("rendered"),this.$el.append('<br class="clear"/>')},searchContainer:$("#wpbody h1:first"),search:function(){var i,s=this;1!==e.data.themes.length&&(i=new this.SearchView({collection:s.collection,parent:this}),i.render(),this.searchContainer.append($.parseHTML('<label class="screen-reader-text" for="wp-filter-search-input">'+t.search+"</label>")).append(i.el))},scroller:function(){var e=this,t,i;t=this.window.scrollTop()+e.window.height(),i=e.$el.offset().top+e.$el.outerHeight(!1)-e.window.height(),i=Math.round(.9*i),t>i&&this.trigger("theme:scroll")}}),e.Collection=Backbone.Collection.extend({model:e.Model,terms:"",doSearch:function(t){this.terms!==t&&(this.terms=t,this.terms.length>0&&this.search(this.terms),""===this.terms&&(this.reset(e.data.themes),$("body").removeClass("no-results")),this.trigger("update"))},search:function(t){var i,s,r,n,a,o;this.reset(e.data.themes,{silent:!0}),t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),t=t.replace(/ /g,")(?=.*"),i=new RegExp("^(?=.*"+t+").+","i"),s=this.filter(function(e){return n=e.get("name").replace(/(<([^>]+)>)/gi,""),a=e.get("description").replace(/(<([^>]+)>)/gi,""),o=e.get("author").replace(/(<([^>]+)>)/gi,""),r=_.union(n,e.get("id"),a,o,e.get("tags")),i.test(e.get("author"))&&t.length>2&&e.set("displayAuthor",!0),i.test(r)}),0===s.length?this.trigger("query:empty"):$("body").removeClass("no-results"),this.reset(s)},paginate:function(e){var t=this;return e=e||0,t=_(t.rest(20*e)),t=_(t.first(20))},count:!1,query:function(e){var t=this.queries,i=this,s,r,n;if(this.currentQuery.request=e,s=_.find(t,function(t){return _.isEqual(t.request,e)}),r=_.has(e,"page"),r||(this.currentQuery.page=1),s||r){if(r)return this.apiCall(e,r).done(function(e){i.add(e.themes),i.trigger("query:success"),i.loadingThemes=!1}).fail(function(){i.trigger("query:fail")});0===s.themes.length?i.trigger("query:empty"):$("body").removeClass("no-results"),_.isNumber(s.total)&&(this.count=s.total),this.reset(s.themes),s.total||(this.count=this.length),this.trigger("update"),this.trigger("query:success",this.count)}else s=this.apiCall(e).done(function(s){s.themes&&(i.reset(s.themes),n=s.info.results,t.push({themes:s.themes,request:e,total:n})),i.trigger("update"),i.trigger("query:success",n),s.themes&&0===s.themes.length&&i.trigger("query:empty")}).fail(function(){i.trigger("query:fail")})},queries:[],currentQuery:{page:1,request:{}},apiCall:function(e,t){return wp.ajax.send("query-themes",{data:{request:_.extend({per_page:100,fields:{description:!0,tested:!0,requires:!0,rating:!0,downloaded:!0,downloadLink:!0,last_updated:!0,homepage:!0,num_ratings:!0}},e)},beforeSend:function(){t||$("body").addClass("loading-content").removeClass("no-results")}})},loadingThemes:!1}),e.view.Theme=wp.Backbone.View.extend({className:"theme",state:"grid",html:e.template("theme"),events:{click:e.isInstall?"preview":"expand",keydown:e.isInstall?"preview":"expand",touchend:e.isInstall?"preview":"expand",keyup:"addFocus",touchmove:"preventExpand"},touchDrag:!1,render:function(){var e=this.model.toJSON();this.$el.html(this.html(e)).attr({tabindex:0,"aria-describedby":e.id+"-action "+e.id+"-name"}),this.activeTheme(),this.model.get("displayAuthor")&&this.$el.addClass("display-author"),this.model.get("installed")&&this.$el.addClass("is-installed")},activeTheme:function(){this.model.get("active")&&this.$el.addClass("active")},addFocus:function(){var e=$(":focus").hasClass("theme")?$(":focus"):$(":focus").parents(".theme");$(".theme.focus").removeClass("focus"),e.addClass("focus")},expand:function(t){var i=this;return t=t||window.event,"keydown"!==t.type||13===t.which||32===t.which?this.touchDrag===!0?this.touchDrag=!1:void($(t.target).is(".theme-actions a")||(e.focusedTheme=this.$el,this.trigger("theme:expand",i.model.cid))):void 0},preventExpand:function(){this.touchDrag=!0},preview:function(t){var i=this,s,r;return t=t||window.event,this.touchDrag===!0?this.touchDrag=!1:void($(t.target).hasClass("button-primary")||("keydown"!==t.type||13===t.which||32===t.which)&&("keydown"===t.type&&13!==t.which&&$(":focus").hasClass("button")||(t.preventDefault(),t=t||window.event,e.focusedTheme=this.$el,r=new e.view.Preview({model:this.model}),r.render(),this.setNavButtonsState(),1===this.model.collection.length?r.$el.addClass("no-navigation"):r.$el.removeClass("no-navigation"),$("div.wrap").append(r.el),this.listenTo(r,"theme:next",function(){return s=i.model,_.isUndefined(i.current)||(s=i.current),i.current=i.model.collection.at(i.model.collection.indexOf(s)+1),_.isUndefined(i.current)?(i.options.parent.parent.trigger("theme:end"),i.current=s):(r.model=i.current,r.render(),this.setNavButtonsState(),void $(".next-theme").focus())}).listenTo(r,"theme:previous",function(){s=i.model,0!==i.model.collection.indexOf(i.current)&&(_.isUndefined(i.current)||(s=i.current),i.current=i.model.collection.at(i.model.collection.indexOf(s)-1),_.isUndefined(i.current)||(r.model=i.current,r.render(),this.setNavButtonsState(),$(".previous-theme").focus()))}),this.listenTo(r,"preview:close",function(){i.current=i.model}))))},setNavButtonsState:function(){var e=$(".theme-install-overlay"),t=_.isUndefined(this.current)?this.model:this.current;0===this.model.collection.indexOf(t)&&e.find(".previous-theme").addClass("disabled"),_.isUndefined(this.model.collection.at(this.model.collection.indexOf(t)+1))&&e.find(".next-theme").addClass("disabled")}}),e.view.Details=wp.Backbone.View.extend({className:"theme-overlay",events:{click:"collapse","click .delete-theme":"deleteTheme","click .left":"previousTheme","click .right":"nextTheme"},html:e.template("theme-single"),render:function(){var e=this.model.toJSON();this.$el.html(this.html(e)),this.activeTheme(),this.navigation(),this.screenshotCheck(this.$el),this.containFocus(this.$el)},activeTheme:function(){this.$el.toggleClass("active",this.model.get("active"))},containFocus:function(e){var t;_.delay(function(){$(".theme-wrap a.button-primary:visible").focus()},500),e.on("keydown.wp-themes",function(i){9===i.which&&(t=$(i.target),t.is("button.left")&&i.shiftKey?(e.find(".theme-actions a:last-child").focus(),i.preventDefault()):t.is(".theme-actions a:last-child")&&(e.find("button.left").focus(),i.preventDefault()))})},collapse:function(t){var i=this,s;t=t||window.event,1!==e.data.themes.length&&($(t.target).is(".theme-backdrop")||$(t.target).is(".close")||27===t.keyCode)&&($("body").addClass("closing-overlay"),this.$el.fadeOut(130,function(){$("body").removeClass("closing-overlay"),i.closeOverlay(),s=document.body.scrollTop,e.router.navigate(e.router.baseUrl("")),document.body.scrollTop=s,e.focusedTheme&&e.focusedTheme.focus()}))},navigation:function(){this.model.cid===this.model.collection.at(0).cid&&this.$el.find(".left").addClass("disabled"),this.model.cid===this.model.collection.at(this.model.collection.length-1).cid&&this.$el.find(".right").addClass("disabled")},closeOverlay:function(){$("body").removeClass("modal-open"),this.remove(),this.unbind(),this.trigger("theme:collapse")},deleteTheme:function(){return confirm(e.data.settings.confirmDelete)},nextTheme:function(){var e=this;return e.trigger("theme:next",e.model.cid),!1},previousTheme:function(){var e=this;return e.trigger("theme:previous",e.model.cid),!1},screenshotCheck:function(e){var t,i;t=e.find(".screenshot img"),i=new Image,i.src=t.attr("src"),i.width&&i.width<=300&&e.addClass("small-screenshot")}}),e.view.Preview=e.view.Details.extend({className:"wp-full-overlay expanded",el:".theme-install-overlay",events:{"click .close-full-overlay":"close","click .collapse-sidebar":"collapse","click .previous-theme":"previousTheme","click .next-theme":"nextTheme",keyup:"keyEvent"},html:e.template("theme-preview"),render:function(){var t=this,i=this.model.toJSON();this.$el.removeClass("iframe-ready").html(this.html(i)),e.router.navigate(e.router.baseUrl(e.router.themePath+this.model.get("id")),{replace:!0}),this.$el.fadeIn(200,function(){$("body").addClass("theme-installer-active full-overlay-active"),$(".close-full-overlay").focus()}),this.$el.find("iframe").one("load",function(){t.iframeLoaded()})},iframeLoaded:function(){this.$el.addClass("iframe-ready")},close:function(){return this.$el.fadeOut(200,function(){$("body").removeClass("theme-installer-active full-overlay-active"),e.focusedTheme&&e.focusedTheme.focus()}).removeClass("iframe-ready"),e.router.navigate(e.router.baseUrl("")),this.trigger("preview:close"),this.undelegateEvents(),this.unbind(),!1},collapse:function(e){var i=$(e.currentTarget);return"true"===i.attr("aria-expanded")?i.attr({"aria-expanded":"false","aria-label":t.expandSidebar}):i.attr({"aria-expanded":"true","aria-label":t.collapseSidebar}),this.$el.toggleClass("collapsed").toggleClass("expanded"),!1},keyEvent:function(e){27===e.keyCode&&(this.undelegateEvents(),this.close()),39===e.keyCode&&_.once(this.nextTheme()),37===e.keyCode&&this.previousTheme()}}),e.view.Themes=wp.Backbone.View.extend({className:"themes",$overlay:$("div.theme-overlay"),index:0,count:$(".wp-core-ui .theme-count"),liveThemeCount:0,initialize:function(e){var t=this;this.parent=e.parent,this.setView("grid"),t.currentTheme(),this.listenTo(t.collection,"update",function(){t.parent.page=0,t.currentTheme(),t.render(this)}),this.listenTo(t.collection,"query:success",function(e){_.isNumber(e)?(t.count.text(e),t.announceSearchResults(e)):(t.count.text(t.collection.length),t.announceSearchResults(t.collection.length))}),this.listenTo(t.collection,"query:empty",function(){$("body").addClass("no-results")}),this.listenTo(this.parent,"theme:scroll",function(){t.renderThemes(t.parent.page)}),this.listenTo(this.parent,"theme:close",function(){t.overlay&&t.overlay.closeOverlay()}),$("body").on("keyup",function(e){t.overlay&&(39===e.keyCode&&t.overlay.nextTheme(),37===e.keyCode&&t.overlay.previousTheme(),27===e.keyCode&&t.overlay.collapse(e))})},render:function(){this.$el.empty(),1===e.data.themes.length&&(this.singleTheme=new e.view.Details({model:this.collection.models[0]}),this.singleTheme.render(),this.$el.addClass("single-theme"),this.$el.append(this.singleTheme.el)),this.options.collection.size()>0&&this.renderThemes(this.parent.page),this.liveThemeCount=this.collection.count?this.collection.count:this.collection.length,this.count.text(this.liveThemeCount),this.announceSearchResults(this.liveThemeCount)},renderThemes:function(i){var s=this;return s.instance=s.collection.paginate(i),0===s.instance.size()?void this.parent.trigger("theme:end"):(!e.isInstall&&i>=1&&$(".add-new-theme").remove(),s.instance.each(function(t){s.theme=new e.view.Theme({model:t,parent:s}),s.theme.render(),s.$el.append(s.theme.el),s.listenTo(s.theme,"theme:expand",s.expand,s)}),!e.isInstall&&e.data.settings.canInstall&&this.$el.append('<div class="theme add-new-theme"><a href="'+e.data.settings.installURI+'"><div class="theme-screenshot"><span></span></div><h2 class="theme-name">'+t.addNew+"</h2></a></div>"),void this.parent.page++)},currentTheme:function(){var e=this,t;t=e.collection.findWhere({active:!0}),t&&(e.collection.remove(t),e.collection.add(t,{at:0}))},setView:function(e){return e},expand:function(t){var i=this;this.model=i.collection.get(t),e.router.navigate(e.router.baseUrl(e.router.themePath+this.model.id)),this.setView("detail"),$("body").addClass("modal-open"),this.overlay=new e.view.Details({model:i.model}),this.overlay.render(),this.$overlay.html(this.overlay.el),this.listenTo(this.overlay,"theme:next",function(){i.next([i.model.cid])}).listenTo(this.overlay,"theme:previous",function(){i.previous([i.model.cid])})},next:function(e){var t=this,i,s;i=t.collection.get(e[0]),s=t.collection.at(t.collection.indexOf(i)+1),void 0!==s&&(this.overlay.closeOverlay(),t.theme.trigger("theme:expand",s.cid))},previous:function(e){var t=this,i,s;i=t.collection.get(e[0]),s=t.collection.at(t.collection.indexOf(i)-1),void 0!==s&&(this.overlay.closeOverlay(),t.theme.trigger("theme:expand",s.cid))},announceSearchResults:function(e){0===e?wp.a11y.speak(t.noThemesFound):wp.a11y.speak(t.themesFound.replace("%d",e))}}),e.view.Search=wp.Backbone.View.extend({tagName:"input",className:"wp-filter-search",id:"wp-filter-search-input",searching:!1,attributes:{placeholder:t.searchPlaceholder,type:"search","aria-describedby":"live-search-desc"},events:{input:"search",keyup:"search",blur:"pushState"},initialize:function(e){this.parent=e.parent,this.listenTo(this.parent,"theme:close",function(){this.searching=!1})},search:function(e){"keyup"===e.type&&27===e.which&&(e.target.value=""),this.doSearch(e)},doSearch:_.debounce(function(t){var i={};this.collection.doSearch(t.target.value),this.searching&&13!==t.which?i.replace=!0:this.searching=!0,t.target.value?e.router.navigate(e.router.baseUrl(e.router.searchPath+t.target.value),i):e.router.navigate(e.router.baseUrl(""))},500),pushState:function(t){var i=e.router.baseUrl("");t.target.value&&(i=e.router.baseUrl(e.router.searchPath+t.target.value)),this.searching=!1,e.router.navigate(i)}}),e.Router=Backbone.Router.extend({routes:{"themes.php?theme=:slug":"theme","themes.php?search=:query":"search","themes.php?s=:query":"search","themes.php":"themes","":"themes"},baseUrl:function(e){return"themes.php"+e},themePath:"?theme=",searchPath:"?search=",search:function(e){$(".wp-filter-search").val(e)},themes:function(){$(".wp-filter-search").val("")},navigate:function(){Backbone.history._hasPushState&&Backbone.Router.prototype.navigate.apply(this,arguments)}}),e.Run={init:function(){this.themes=new e.Collection(e.data.themes),this.view=new e.view.Appearance({collection:this.themes}),this.render()},render:function(){this.view.render(),this.routes(),Backbone.history.start({root:e.data.settings.adminUrl,pushState:!0,hashChange:!1})},routes:function(){var t=this;e.router=new e.Router,e.router.on("route:theme",function(e){t.view.view.expand(e)}),e.router.on("route:themes",function(){t.themes.doSearch(""),t.view.trigger("theme:close")}),e.router.on("route:search",function(){$(".wp-filter-search").trigger("keyup")}),this.extraRoutes()},extraRoutes:function(){return!1}},e.view.InstallerSearch=e.view.Search.extend({events:{input:"search",keyup:"search"},search:function(e){("keyup"!==e.type||9!==e.which&&16!==e.which)&&(this.collection=this.options.parent.view.collection,"keyup"===e.type&&27===e.which&&(e.target.value=""),this.doSearch(e.target.value))},doSearch:_.debounce(function(t){var i={};i.search=t,"author:"===t.substring(0,7)&&(i.search="",i.author=t.slice(7)),"tag:"===t.substring(0,4)&&(i.search="",i.tag=[t.slice(4)]),$(".filter-links li > a.current").removeClass("current"),$("body").removeClass("show-filters filters-applied show-favorites-form"),this.collection.query(i),e.router.navigate(e.router.baseUrl(e.router.searchPath+t),{replace:!0})},500)}),e.view.Installer=e.view.Appearance.extend({el:"#wpbody-content .wrap",events:{"click .filter-links li > a":"onSort","click .theme-filter":"onFilter","click .drawer-toggle":"moreFilters","click .filter-drawer .apply-filters":"applyFilters",'click .filter-group [type="checkbox"]':"addFilter","click .filter-drawer .clear-filters":"clearFilters","click .filtered-by":"backToFilters","click .favorites-form-submit":"saveUsername","keyup #wporg-username-input":"saveUsername"},render:function(){var i=this;this.search(),this.uploader(),this.collection=new e.Collection,this.listenTo(this,"theme:end",function(){i.collection.loadingThemes||(i.collection.loadingThemes=!0,i.collection.currentQuery.page++,_.extend(i.collection.currentQuery.request,{page:i.collection.currentQuery.page}),i.collection.query(i.collection.currentQuery.request))}),this.listenTo(this.collection,"query:success",function(){$("body").removeClass("loading-content"),$(".theme-browser").find("div.error").remove()}),this.listenTo(this.collection,"query:fail",function(){$("body").removeClass("loading-content"),$(".theme-browser").find("div.error").remove(),$(".theme-browser").find("div.themes").before('<div class="error"><p>'+t.error+"</p></div>")}),this.view&&this.view.remove(),this.view=new e.view.Themes({collection:this.collection,parent:this}),this.page=0,this.$el.find(".themes").remove(),this.view.render(),this.$el.find(".theme-browser").append(this.view.el).addClass("rendered")},browse:function(e){this.collection.query({browse:e})},onSort:function(t){var i=$(t.target),s=i.data("sort");t.preventDefault(),$("body").removeClass("filters-applied show-filters"),i.hasClass(this.activeClass)||(this.sort(s),e.router.navigate(e.router.baseUrl(e.router.browsePath+s)))},sort:function(e){this.clearSearch(),$(".filter-links li > a, .theme-filter").removeClass(this.activeClass),$('[data-sort="'+e+'"]').addClass(this.activeClass),"favorites"===e?$("body").addClass("show-favorites-form"):$("body").removeClass("show-favorites-form"),this.browse(e)},onFilter:function(e){var t,i=$(e.target),s=i.data("filter");i.hasClass(this.activeClass)||($(".filter-links li > a, .theme-section").removeClass(this.activeClass),i.addClass(this.activeClass),s&&(s=_.union(s,this.filtersChecked()),t={tag:[s]},this.collection.query(t)))},addFilter:function(){this.filtersChecked()},applyFilters:function(e){var t,i=this.filtersChecked(),s={tag:i},r=$(".filtered-by .tags");e&&e.preventDefault(),$("body").addClass("filters-applied"),$(".filter-links li > a.current").removeClass("current"),r.empty(),_.each(i,function(e){t=$('label[for="filter-id-'+e+'"]').text(),r.append('<span class="tag">'+t+"</span>")}),this.collection.query(s)},saveUsername:function(e){var t=$("#wporg-username-input").val(),i={browse:"favorites",user:t},s=this;return e&&e.preventDefault(),"keyup"!==e.type||13===e.which?wp.ajax.send("save-wporg-username",{data:{username:t},success:function(){s.collection.query(i)}}):void 0},filtersChecked:function(){var e=$(".filter-group").find(":checkbox"),t=[];return _.each(e.filter(":checked"),function(e){t.push($(e).prop("value"))}),0===t.length?($(".filter-drawer .apply-filters").find("span").text(""),$(".filter-drawer .clear-filters").hide(),$("body").removeClass("filters-applied"),!1):($(".filter-drawer .apply-filters").find("span").text(t.length),$(".filter-drawer .clear-filters").css("display","inline-block"),t)},activeClass:"current",searchContainer:$(".wp-filter .search-form"),uploader:function(){$("a.upload").on("click",function(t){t.preventDefault(),$("body").addClass("show-upload-theme"),e.router.navigate(e.router.baseUrl("?upload"),{replace:!0})}),$("a.browse-themes").on("click",function(t){t.preventDefault(),$("body").removeClass("show-upload-theme"),e.router.navigate(e.router.baseUrl(""),{replace:!0})})},moreFilters:function(t){return t.preventDefault(),$("body").hasClass("filters-applied")?this.backToFilters():$("body").hasClass("show-filters")&&this.filtersChecked()?this.addFilter():(this.clearSearch(),e.router.navigate(e.router.baseUrl("")),void $("body").toggleClass("show-filters"))},clearFilters:function(e){var t=$(".filter-group").find(":checkbox"),i=this;e.preventDefault(),_.each(t.filter(":checked"),function(e){return $(e).prop("checked",!1),i.filtersChecked()})},backToFilters:function(e){e&&e.preventDefault(),$("body").removeClass("filters-applied")},clearSearch:function(){$("#wp-filter-search-input").val("")}}),e.InstallerRouter=Backbone.Router.extend({routes:{"theme-install.php?theme=:slug":"preview","theme-install.php?browse=:sort":"sort","theme-install.php?upload":"upload","theme-install.php?search=:query":"search","theme-install.php":"sort"},baseUrl:function(e){return"theme-install.php"+e},themePath:"?theme=",browsePath:"?browse=",searchPath:"?search=",search:function(e){$(".wp-filter-search").val(e)},navigate:function(){Backbone.history._hasPushState&&Backbone.Router.prototype.navigate.apply(this,arguments)}}),e.RunInstaller={init:function(){this.view=new e.view.Installer({section:"featured",SearchView:e.view.InstallerSearch}),this.render()},render:function(){this.view.render(),this.routes(),Backbone.history.start({root:e.data.settings.adminUrl,pushState:!0,hashChange:!1})},routes:function(){var t=this,i={};e.router=new e.InstallerRouter,e.router.on("route:preview",function(e){i.theme=e,t.view.collection.query(i),t.view.collection.once("update",function(){t.view.view.theme.preview()})}),e.router.on("route:sort",function(e){e||(e="featured"),t.view.sort(e),t.view.trigger("theme:close")}),e.router.on("route:upload",function(){$("a.upload").trigger("click")}),e.router.on("route:search",function(){$(".wp-filter-search").focus().trigger("keyup")}),this.extraRoutes()},extraRoutes:function(){return!1}},$(document).ready(function(){e.isInstall?e.RunInstaller.init():e.Run.init(),$(".broken-themes .delete-theme").on("click",function(){return confirm(_wpThemeSettings.settings.confirmDelete)})})}(jQuery);var tb_position;jQuery(document).ready(function($){tb_position=function(){var e=$("#TB_window"),t=$(window).width(),i=$(window).height(),s=t>1040?1040:t,r=0;$("#wpadminbar").length&&(r=parseInt($("#wpadminbar").css("height"),10)),e.size()&&(e.width(s-50).height(i-45-r),$("#TB_iframeContent").width(s-50).height(i-75-r),e.css({"margin-left":"-"+parseInt((s-50)/2,10)+"px"}),"undefined"!=typeof document.body.style.maxWidth&&e.css({top:20+r+"px","margin-top":"0"}))},$(window).resize(function(){tb_position()})});