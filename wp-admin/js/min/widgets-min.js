var wpWidgets;!function($){var e=$(document);wpWidgets={hoveredSidebar:null,init:function(){var i,t,s=this,d=$(".widgets-chooser"),n=d.find(".widgets-chooser-sidebars"),a=$("div.widgets-sortables"),r=!("undefined"==typeof isRtl||!isRtl);$("#widgets-right .sidebar-name").click(function(){var i=$(this),t=i.closest(".widgets-holder-wrap");t.hasClass("closed")?(t.removeClass("closed"),i.parent().sortable("refresh")):t.addClass("closed"),e.triggerHandler("wp-pin-menu")}),$("#widgets-left .sidebar-name").click(function(){$(this).closest(".widgets-holder-wrap").toggleClass("closed"),e.triggerHandler("wp-pin-menu")}),$(document.body).bind("click.widgets-toggle",function(e){var i=$(e.target),t={"z-index":100},s,d,n,a,o;i.parents(".widget-top").length&&!i.parents("#available-widgets").length?(s=i.closest("div.widget"),d=s.children(".widget-inside"),n=parseInt(s.find("input.widget-width").val(),10),a=s.parent().width(),d.is(":hidden")?(n>250&&n+30>a&&s.closest("div.widgets-sortables").length&&(o=s.closest("div.widget-liquid-right").length?r?"margin-right":"margin-left":r?"margin-left":"margin-right",t[o]=a-(n+30)+"px",s.css(t)),s.addClass("open"),d.slideDown("fast")):d.slideUp("fast",function(){s.attr("style",""),s.removeClass("open")}),e.preventDefault()):i.hasClass("widget-control-save")?(wpWidgets.save(i.closest("div.widget"),0,1,0),e.preventDefault()):i.hasClass("widget-control-remove")?(wpWidgets.save(i.closest("div.widget"),1,1,0),e.preventDefault()):i.hasClass("widget-control-close")?(s=i.closest("div.widget"),s.removeClass("open"),wpWidgets.close(s),e.preventDefault()):"inactive-widgets-control-remove"===i.attr("id")&&(wpWidgets.removeInactiveWidgets(),e.preventDefault())}),a.children(".widget").each(function(){var e=$(this);wpWidgets.appendTitle(this),e.find("p.widget-error").length&&e.find("a.widget-action").trigger("click")}),$("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"#wpwrap",refreshPositions:!0,start:function(e,i){var d=$(this).find(".widgets-chooser");i.helper.find("div.widget-description").hide(),t=this.id,d.length&&($("#wpbody-content").append(d.hide()),i.helper.find(".widgets-chooser").remove(),s.clearWidgetSelection())},stop:function(){i&&$(i).hide(),i=""}}),a.droppable({tolerance:"intersect",over:function(e){var i=$(e.target).parent();wpWidgets.hoveredSidebar&&!i.is(wpWidgets.hoveredSidebar)&&wpWidgets.closeSidebar(e),i.hasClass("closed")&&(wpWidgets.hoveredSidebar=i,i.removeClass("closed")),$(this).sortable("refresh")},out:function(e){wpWidgets.hoveredSidebar&&wpWidgets.closeSidebar(e)}}),a.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"#wpwrap",tolerance:"pointer",refreshPositions:!0,start:function(e,i){var t,s=$(this),d=s.parent(),n=i.item.children(".widget-inside");"block"===n.css("display")&&(i.item.removeClass("open"),n.hide(),$(this).sortable("refreshPositions")),d.hasClass("closed")||(t=i.item.hasClass("ui-draggable")?s.height():1+s.height(),s.css("min-height",t+"px"))},stop:function(s,d){var n,a,r,o,l,c,g=d.item,w=t;return wpWidgets.hoveredSidebar=null,g.hasClass("deleting")?(wpWidgets.save(g,1,0,1),void g.remove()):(n=g.find("input.add_new").val(),a=g.find("input.multi_number").val(),g.attr("style","").removeClass("ui-draggable"),t="",n&&("multi"===n?(g.html(g.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,a)})),g.attr("id",w.replace("__i__",a)),a++,$("div#"+w).find("input.multi_number").val(a)):"single"===n&&(g.attr("id","new-"+w),i="div#"+w),wpWidgets.save(g,0,0,1),g.find("input.add_new").val(""),e.trigger("widget-added",[g])),r=g.parent(),r.parent().hasClass("closed")&&(r.parent().removeClass("closed"),o=r.children(".widget"),o.length>1&&(l=o.get(0),c=g.get(0),l.id&&c.id&&l.id!==c.id&&$(l).before(g))),void(n?g.find("a.widget-action").trigger("click"):wpWidgets.saveOrder(r.attr("id"))))},activate:function(){$(this).parent().addClass("widget-hover")},deactivate:function(){$(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(e,i){var t=$(i.sender);return this.id.indexOf("orphaned_widgets")>-1?void t.sortable("cancel"):void(t.attr("id").indexOf("orphaned_widgets")>-1&&!t.children(".widget").length&&t.parents(".orphan-sidebar").slideUp(400,function(){$(this).remove()}))}}).sortable("option","connectWith","div.widgets-sortables"),$("#available-widgets").droppable({tolerance:"pointer",accept:function(e){return"widget-list"!==$(e).parent().attr("id")},drop:function(e,i){i.draggable.addClass("deleting"),$("#removing-widget").hide().children("span").empty()},over:function(e,i){i.draggable.addClass("deleting"),$("div.widget-placeholder").hide(),i.draggable.hasClass("ui-sortable-helper")&&$("#removing-widget").show().children("span").html(i.draggable.find("div.widget-title").children("h3").html())},out:function(e,i){i.draggable.removeClass("deleting"),$("div.widget-placeholder").show(),$("#removing-widget").hide().children("span").empty()}}),$("#widgets-right .widgets-holder-wrap").each(function(e,i){var t=$(i),s=t.find(".sidebar-name h2").text(),d=t.find(".widgets-sortables").attr("id"),a=$('<li tabindex="0">').text($.trim(s));0===e&&a.addClass("widgets-chooser-selected"),n.append(a),a.data("sidebarId",d)}),$("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var e=$(this).closest(".widget");e.hasClass("widget-in-question")||$("#widgets-left").hasClass("chooser")?s.closeChooser():(s.clearWidgetSelection(),$("#widgets-left").addClass("chooser"),e.addClass("widget-in-question").children(".widget-description").after(d),d.slideDown(300,function(){n.find(".widgets-chooser-selected").focus()}),n.find("li").on("focusin.widgets-chooser",function(){n.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected"),$(this).addClass("widgets-chooser-selected")}))}),d.on("click.widgets-chooser",function(e){var i=$(e.target);i.hasClass("button-primary")?(s.addWidget(d),s.closeChooser()):i.hasClass("button-secondary")&&s.closeChooser()}).on("keyup.widgets-chooser",function(e){e.which===$.ui.keyCode.ENTER?$(e.target).hasClass("button-secondary")?s.closeChooser():(s.addWidget(d),s.closeChooser()):e.which===$.ui.keyCode.ESCAPE&&s.closeChooser()})},saveOrder:function(e){var i={action:"widgets-order",savewidgets:$("#_wpnonce_widgets").val(),sidebars:[]};e&&$("#"+e).find(".spinner:first").addClass("is-active"),$("div.widgets-sortables").each(function(){$(this).sortable&&(i["sidebars["+$(this).attr("id")+"]"]=$(this).sortable("toArray").join(","))}),$.post(ajaxurl,i,function(){$("#inactive-widgets-control-remove").prop("disabled",!$("#wp_inactive_widgets .widget").length),$(".spinner").removeClass("is-active")})},save:function(i,t,s,d){var n=i.closest("div.widgets-sortables").attr("id"),a=i.find("form").serialize(),r;i=$(i),$(".spinner",i).addClass("is-active"),r={action:"save-widget",savewidgets:$("#_wpnonce_widgets").val(),sidebar:n},t&&(r.delete_widget=1),a+="&"+$.param(r),$.post(ajaxurl,a,function(a){var r;t?($("input.widget_number",i).val()||(r=$("input.widget-id",i).val(),$("#available-widgets").find("input.widget-id").each(function(){$(this).val()===r&&$(this).closest("div.widget").show()})),s?(d=0,i.slideUp("fast",function(){$(this).remove(),wpWidgets.saveOrder()})):(i.remove(),"wp_inactive_widgets"===n&&$("#inactive-widgets-control-remove").prop("disabled",!$("#wp_inactive_widgets .widget").length))):($(".spinner").removeClass("is-active"),a&&a.length>2&&($("div.widget-content",i).html(a),wpWidgets.appendTitle(i),e.trigger("widget-updated",[i]),"wp_inactive_widgets"===n&&$("#inactive-widgets-control-remove").prop("disabled",!$("#wp_inactive_widgets .widget").length))),d&&wpWidgets.saveOrder()})},removeInactiveWidgets:function(){var e=$(".remove-inactive-widgets"),i,t;$(".spinner",e).addClass("is-active"),i={action:"delete-inactive-widgets",removeinactivewidgets:$("#_wpnonce_remove_inactive_widgets").val()},t=$.param(i),$.post(ajaxurl,t,function(){$("#wp_inactive_widgets .widget").remove(),$("#inactive-widgets-control-remove").prop("disabled",!0),$(".spinner",e).removeClass("is-active")})},appendTitle:function(e){var i=$('input[id*="-title"]',e).val()||"";i&&(i=": "+i.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")),$(e).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(i)},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.attr("style","")})},addWidget:function(i){var t,s,d,n,a,r,o,l=i.find(".widgets-chooser-selected").data("sidebarId"),c=$("#"+l);t=$("#available-widgets").find(".widget-in-question").clone(),s=t.attr("id"),d=t.find("input.add_new").val(),n=t.find("input.multi_number").val(),t.find(".widgets-chooser").remove(),"multi"===d?(t.html(t.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,n)})),t.attr("id",s.replace("__i__",n)),n++,$("#"+s).find("input.multi_number").val(n)):"single"===d&&(t.attr("id","new-"+s),$("#"+s).hide()),c.closest(".widgets-holder-wrap").removeClass("closed"),c.append(t),c.sortable("refresh"),wpWidgets.save(t,0,0,1),t.find("input.add_new").val(""),e.trigger("widget-added",[t]),a=$(window).scrollTop(),r=a+$(window).height(),o=c.offset(),o.bottom=o.top+c.outerHeight(),(a>o.bottom||r<o.top)&&$("html, body").animate({scrollTop:o.top-130},200),window.setTimeout(function(){t.find(".widget-title").trigger("click")},250)},closeChooser:function(){var e=this;$(".widgets-chooser").slideUp(200,function(){$("#wpbody-content").append(this),e.clearWidgetSelection()})},clearWidgetSelection:function(){$("#widgets-left").removeClass("chooser"),$(".widget-in-question").removeClass("widget-in-question")},closeSidebar:function(e){this.hoveredSidebar.addClass("closed"),$(e.target).css("min-height",""),this.hoveredSidebar=null}},e.ready(function(){wpWidgets.init()})}(jQuery);